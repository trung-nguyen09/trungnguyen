<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Gửi Mail</title>
    <link rel="icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
        }
        .file-drop-area {
            transition: all 0.3s ease;
        }
        .file-drop-area.dragover {
            background-color: #e0f2fe; /* light-blue-100 */
            border-color: #3b82f6; /* blue-500 */
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        /* Header styles */
        .header-container {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-radius: 12px;
            padding: 24px;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .header-icon {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            animation: bounceIcon 2s ease-in-out infinite;
        }
        @keyframes bounceIcon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .header-text h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .header-text p {
            margin: 4px 0 0 0;
            font-size: 14px;
            opacity: 0.95;
        }
        @media (max-width: 768px) {
            .header-container {
                padding: 16px;
            }
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            .header-icon {
                width: 50px;
                height: 50px;
            }
            .header-text h1 {
                font-size: 22px;
            }
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <div class="header-container">
                <div class="header-content">
                    <div class="header-icon">
                        <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="48" height="48" rx="8" fill="#FF6B35"/>
                            <text x="24" y="32" font-size="28" font-weight="700" text-anchor="middle" fill="white" font-family="Arial, sans-serif">S</text>
                        </svg>
                    </div>
                    <div class="header-text">
                        <h1>[VNS] - Tools gửi mail 3pls - Version 2.3</h1>
                        <p>Tool được built bởi Trung Nguyễn, có gì thắc mắc liên hệ quoctrung.nguyen@shopee.com.</p>
                    </div>
                </div>
            </div>
        </header>
        <main>
            <section id="upload-section" class="bg-white rounded-xl shadow-md p-6 mb-8">
                <div id="file-drop-area" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer">
                    <input type="file" id="file-input" multiple accept=".xlsx" class="hidden">
                    <div class="flex flex-col items-center">
                        <svg class="w-12 h-12 text-gray-400 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
                        </svg>
                        <p class="font-semibold text-gray-700">Kéo và thả file hoặc <span class="text-blue-500">nhấn để chọn file</span></p>
                        <p class="text-xs text-gray-500 mt-1">Hỗ trợ nhiều file .xlsx</p>
                    </div>
                </div>
                <div id="file-list" class="mt-4 text-sm text-gray-600"></div>
                <div id="loader" class="hidden flex justify-center items-center mt-4">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                    <p class="ml-4 text-gray-600">Đang xử lý, vui lòng chờ...</p>
                </div>
            </section>
            <section id="scorecard-section" class="hidden mb-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Tổng Quan Đơn Hàng</h2>
                <div id="scorecard-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                </div>
            </section>
            <section id="data-section" class="bg-white rounded-xl shadow-md p-6 hidden">
                <div class="flex flex-col md:flex-row justify-between md:items-center mb-4">
                    <h2 class="text-2xl font-bold mb-2 md:mb-0">Chi Tiết Đơn Hàng</h2>
                    <div class="flex space-x-2">
                        <button id="remove-order-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            Remove Order
                        </button>

                        <button id="add-order-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-md transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Order Pending
                        </button>

                        <button id="export-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            Export to Excel
                        </button>
                        <button id="text-to-email-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                            Text to Email
                        </button>

                        <button id="add-order-ck-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-md transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                            </svg>
                            Add Order CK
                        </button>

                        <button id="show-summary-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-md transition-colors flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
                            </svg>
                            Report Summary
                        </button>

                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="filter-3pl" class="block text-sm font-medium text-gray-700 mb-1">Lọc theo New 3PL</label>
                        <select id="filter-3pl" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Tất cả 3PL</option>
                        </select>
                    </div>
                    <div>
                        <label for="filter-date" class="block text-sm font-medium text-gray-700 mb-1">Lọc theo Shipped Date</label>
                        <input type="date" id="filter-date" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">&nbsp;</label>
                        <button id="reset-filters" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Xoá bộ lọc</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">New 3PL</th>
                                <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">LM Tracking No</th>
                                <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                                <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Shipped Date</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                        </tbody>
                    </table>
                </div>
                <div id="no-results" class="text-center py-8 text-gray-500 hidden">
                    <p>Không tìm thấy kết quả phù hợp.</p>
                </div>
                <div id="pagination-controls" class="flex justify-between items-center mt-6">
                </div>
            </section>
        </main>
    </div>
    <div id="remove-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-container">
            <h3 class="text-lg font-bold mb-4">Remove Orders</h3>
            <p class="text-sm text-gray-600 mb-4">Dán danh sách mã đơn hàng (LM Tracking Number) cần xoá, mỗi mã một dòng.</p>
            <textarea id="remove-tracking-numbers" class="w-full h-40 p-2 border border-gray-300 rounded-md" placeholder="NTF...&#10;SPXVN...&#10;..."></textarea>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="close-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md transition-colors">Đóng</button>
                <button id="submit-removal-btn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Xác nhận Xoá</button>
            </div>
        </div>
    </div>

    <div id="add-order-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-container">
            <h3 class="text-lg font-bold mb-4">Add Orders Pending</h3>
            <p class="text-sm text-gray-600 mb-4">Dán danh sách mã đơn hàng (LM Tracking Number) cần thêm, mỗi mã một dòng.</p>
            <textarea id="add-tracking-numbers" class="w-full h-40 p-2 border border-gray-300 rounded-md" placeholder="NTF...&#10;SPXVN...&#10;..."></textarea>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="close-add-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md transition-colors">Đóng</button>
                <button id="submit-add-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-md transition-colors">Xác nhận Thêm</button>
            </div>
        </div>
    </div>

    <div id="add-order-ck-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-container">
            <h3 class="text-lg font-bold mb-4">Add Order CK (Ahamove_CK)</h3>
            <p class="text-sm text-gray-600 mb-4">Dán danh sách mã đơn hàng (LM Tracking Number) cần thêm vào AhamoveCK, mỗi mã một dòng.</p>
            <textarea id="add-ck-tracking-numbers" class="w-full h-40 p-2 border border-gray-300 rounded-md" placeholder="NTF...&#10;SPXVN...&#10;..."></textarea>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="close-add-ck-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md transition-colors">Đóng</button>
                <button id="submit-add-ck-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-md transition-colors">Xác nhận Thêm CK</button>
            </div>
        </div>
    </div>

    <div id="summary-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-6xl modal-container relative">
            <button id="close-summary-btn" class="absolute top-2 right-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-full w-8 h-8 flex items-center justify-center">&times;</button>
            <button id="crop-summary-btn" class="absolute top-2 right-14 bg-green-500 hover:bg-green-600 text-white font-bold rounded-full w-8 h-8 flex items-center justify-center" title="Crop img to clipboard">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16v4a2 2 0 002 2h4a2 2 0 002-2v-4m4-4V8a2 2 0 00-2-2h-4m0-4h-4a2 2 0 00-2 2v4m0 4v4a2 2 0 002 2h4" />
                </svg>
            </button>
            <section id="summary-section">
                <h2 class="px-8 text-2xl font-bold mb-4 text-gray-800" id="summary-title">Report handover to 3PLs</h2>
                <div class="overflow-x-auto">
                    <table class="w-full min-w-[900px] bg-white border border-gray-200 table-fixed" id="summary-table">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="py-3 px-8 border-b text-left text-xs font-semibold text-gray-600 uppercase w-[170px]">3PLs</th>
                                <th class="py-3 px-8 border-b text-right text-xs font-semibold text-gray-600 uppercase w-[120px]"># Order</th>
                                <th class="py-3 px-8 border-b text-right text-xs font-semibold text-gray-600 uppercase w-[120px]">% Order</th>
                                <th class="py-3 px-8 border-b text-right text-xs font-semibold text-gray-600 uppercase w-[120px]">Pending</th>
                                <th class="py-3 px-8 border-b text-left text-xs font-semibold text-gray-600 uppercase min-w-[210px]">Reason</th>
                            </tr>
                        </thead>

                        <tbody id="summary-tbody"></tbody>
                        <tfoot>
                            <tr class="bg-orange-200 font-bold">
                                <td class="py-3 px-8 border-t text-right">Total</td>
                                <td class="py-3 px-8 border-t text-right" id="total-orders"></td>
                                <td class="py-3 px-8 border-t text-right" id="total-percent">100.00%</td>
                                <td class="py-3 px-8 border-t text-right" id="total-removed"></td>
                                <td class="py-3 px-8 border-t"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>
        </div>

    </div>



    <div id="text-to-email-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden modal-overlay">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md modal-container">
            <h3 class="text-lg font-bold mb-4">Text to Email</h3>
            <p class="text-sm text-gray-600 mb-4">Chọn 3PL để sao chép nội dung email:</p>
            <div id="pl-buttons" class="grid grid-cols-1 gap-3 mb-6">
                <!-- Buttons will be dynamically generated -->
            </div>
            <div class="flex justify-end">
                <button id="close-email-modal-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md transition-colors">Đóng</button>
            </div>
        </div>
    </div>
    <script>
        // --- DOM Elements ---
        const fileDropArea = document.getElementById('file-drop-area');
        const fileInput = document.getElementById('file-input');
        const fileList = document.getElementById('file-list');
        const loader = document.getElementById('loader');
        const scorecardSection = document.getElementById('scorecard-section');
        const scorecardContainer = document.getElementById('scorecard-container');
        const dataSection = document.getElementById('data-section');
        const tableBody = document.getElementById('data-table-body');
        const paginationControls = document.getElementById('pagination-controls');
        const filter3PL = document.getElementById('filter-3pl');
        const filterDate = document.getElementById('filter-date');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const noResultsDiv = document.getElementById('no-results');
        const exportBtn = document.getElementById('export-btn');
        const removeOrderBtn = document.getElementById('remove-order-btn');
        const removeOrderModal = document.getElementById('remove-order-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const submitRemovalBtn = document.getElementById('submit-removal-btn');
        const removalTextarea = document.getElementById('remove-tracking-numbers');
        const textToEmailBtn = document.getElementById('text-to-email-btn');
        const textToEmailModal = document.getElementById('text-to-email-modal');
        const closeEmailModalBtn = document.getElementById('close-email-modal-btn');
        const plButtonsContainer = document.getElementById('pl-buttons');
        const addOrderBtn = document.getElementById('add-order-btn');
        const addOrderModal = document.getElementById('add-order-modal');
        const closeAddModalBtn = document.getElementById('close-add-modal-btn');
        const submitAddBtn = document.getElementById('submit-add-btn');
        const addTrackingTextarea = document.getElementById('add-tracking-numbers');
        const addOrderCkBtn = document.getElementById('add-order-ck-btn');
        const addOrderCkModal = document.getElementById('add-order-ck-modal');
        const closeAddCkModalBtn = document.getElementById('close-add-ck-modal-btn');
        const submitAddCkBtn = document.getElementById('submit-add-ck-btn');
        const addCkTrackingTextarea = document.getElementById('add-ck-tracking-numbers');
        const showSummaryBtn = document.getElementById('show-summary-btn');
        const summaryModal = document.getElementById('summary-modal');
        const closeSummaryBtn = document.getElementById('close-summary-btn');

        let allData = [];
        let processedData = [];
        let filteredViewData = [];
        let addingData = [];
        let removedCountBy3PL = {}; // { 'SPX': 5, 'GHN': 2, ... }
        let removedReasonBy3PL = {}; // { 'SPX': '', ... }


        let currentPage = 1;
        const ROWS_PER_PAGE = 15;
        const SCORECARD_3PLS = ['Total Orders', 'Ahamove Hỏa Tốc', 'AhamoveCK', 'SPX Express','SPX Bulky CK','BEST Express', 'Giao Hàng Nhanh'];
        fileDropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => fileDropArea.addEventListener(e, preventDefaults, false));
        ['dragenter', 'dragover'].forEach(e => fileDropArea.addEventListener(e, () => fileDropArea.classList.add('dragover'), false));
        ['dragleave', 'drop'].forEach(e => fileDropArea.addEventListener(e, () => fileDropArea.classList.remove('dragover'), false));
        fileDropArea.addEventListener('drop', handleDrop, false);
        filter3PL.addEventListener('change', applyFilters);
        filterDate.addEventListener('change', applyFilters);
        resetFiltersBtn.addEventListener('click', resetFilters);
        exportBtn.addEventListener('click', exportToExcel);
        removeOrderBtn.addEventListener('click', () => removeOrderModal.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => removeOrderModal.classList.add('hidden'));
        submitRemovalBtn.addEventListener('click', handleOrderRemoval);
        textToEmailBtn.addEventListener('click', openTextToEmailModal);
        closeEmailModalBtn.addEventListener('click', () => textToEmailModal.classList.add('hidden'));
        addOrderBtn.addEventListener('click', () => addOrderModal.classList.remove('hidden'));
        closeAddModalBtn.addEventListener('click', () => {
            addOrderModal.classList.add('hidden');
            addTrackingTextarea.value = '';
        });

        submitAddBtn.addEventListener('click', handleOrderAdding);

        addOrderCkBtn.addEventListener('click', () => addOrderCkModal.classList.remove('hidden'));
        closeAddCkModalBtn.addEventListener('click', () => {
            addOrderCkModal.classList.add('hidden');
            addCkTrackingTextarea.value = '';
        });

        submitAddCkBtn.addEventListener('click', handleOrderAddingCK);

        showSummaryBtn.addEventListener('click', () => {
            updateSummaryTable(); // Cập nhật dữ liệu mỗi lần mở
            summaryModal.classList.remove('hidden');
        });
        closeSummaryBtn.addEventListener('click', () => {
            summaryModal.classList.add('hidden');
        });

        document.getElementById('crop-summary-btn').addEventListener('click', async () => {
            const summarySection = document.getElementById('summary-section');
            // 1. Chuyển input lý do thành text
            const reasonInputs = summarySection.querySelectorAll('input[type="text"]');
            const backup = [];
            reasonInputs.forEach(input => {
                const td = input.parentElement;
                const span = document.createElement('span');
                span.textContent = input.value || '';
                // Thêm CSS cho giống input, căn giữa
                span.style.display = 'block';
                span.style.padding = '0.5rem 1.5rem';      // padding y x (ví dụ py-3 px-6)
                span.style.minHeight = '38px';             // min-height giống input (hoặc table cell)
                span.style.lineHeight = '1.5';
                span.style.fontSize = '16px';              // tuỳ vào text-base, text-xs,...
                span.style.verticalAlign = 'middle';
                span.style.fontFamily = 'inherit';         // giữ font giống table
                // Lưu lại input để sau restore
                backup.push({td, input, span});
                td.replaceChild(span, input);
            });

            // 2. Chụp bảng thành ảnh
            html2canvas(summarySection, {backgroundColor: "#fff", scale: 2}).then(canvas => {
                canvas.toBlob(async (blob) => {
                    try {
                        await navigator.clipboard.write([
                            new window.ClipboardItem({ 'image/png': blob })
                        ]);
                        alert('Đã copy bảng report vào clipboard!');
                    } catch (err) {
                        alert('Copy thất bại. Trình duyệt của bạn có thể chưa hỗ trợ tính năng này.\nBạn vẫn có thể chuột phải vào ảnh để lưu hoặc copy bằng tay.');
                    }
                    // 3. Restore lại input (trả lại DOM gốc)
                    backup.forEach(({td, input, span}) => {
                        td.replaceChild(input, span);
                    });
                }, 'image/png');
            });
        });


        
        // --- Functions ---
        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
        function handleDrop(e) {
            handleFileSelect({ target: { files: e.dataTransfer.files } });
        }
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length === 0) return;
            allData = [];
            processedData = [];
            loader.classList.remove('hidden');
            dataSection.classList.add('hidden');
            scorecardSection.classList.add('hidden');
            fileList.innerHTML = `<p>Đã chọn ${files.length} file(s):</p><ul>${Array.from(files).map(f => `<li>- ${f.name}</li>`).join('')}</ul>`;
            Promise.all(Array.from(files).map(processFile))
                .then(results => {
                    allData = results.flat();
                    processAndDisplayData();
                })
                .catch(error => {
                    console.error("Lỗi khi xử lý file:", error);
                    alert("Đã xảy ra lỗi khi đọc file. Vui lòng kiểm tra console.");
                })
                .finally(() => {
                    loader.classList.add('hidden');
                });
        }
        function processFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array', cellDates: true });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        resolve(XLSX.utils.sheet_to_json(worksheet, {raw: false, defval: null}));
                    } catch (err) { reject(err); }
                };
                reader.onerror = (err) => reject(err);
                reader.readAsArrayBuffer(file);
            });
        }
        function rename3PL(originalName, shippedBy) {
            const nameMap = {
                'SPX - Hàng Cồng Kềnh': 'SPX Bulky CK',
                 'Ahamove - Trong Ngày': 'Ahamove Hỏa Tốc',
                 'Ahamove SBS - Trong Ngày': 'Ahamove Hỏa Tốc',
                'Tủ Nhận Hàng': 'SPX Express'};
            // Đặc biệt cho GHN - Hàng Cồng Kềnh
            if (originalName === 'GHN - Hàng Cồng Kềnh') {
                const ahamoveUsers = [
                    'nguyenle.hongtrang12@shopee.com',
                    'tai.lephat12@shopee.com',
                    'thuyduong.dang12@shopee.com'
                ];
                if (ahamoveUsers.includes((shippedBy || '').toLowerCase())) {
                    return 'AhamoveCK';
                }
                return 'Giao Hàng Nhanh';
            }
            // Các rule còn lại
            return nameMap[originalName] || originalName;
        }

        function processAndDisplayData() {
            processedData = allData
                .filter(row => row['Status'] && String(row['Status']).toLowerCase() === 'outbound')
                .map(row => ({
                    'New 3PL': rename3PL(row['New 3PL'] || 'N/A', row['Shipped by']),
                    'LM Tracking No': String(row['LM Tracking No'] || 'N/A'),
                    'Status': String(row['Status']),
                    'Shipped Time': row['Shipped Time'] ? formatDateToYYYYMMDD(row['Shipped Time']) : 'N/A',
                    'Shipped by': String(row['Shipped by'] || '')
                }));

            createScorecards();
            populate3PLFilter();
            applyFilters();
            scorecardSection.classList.remove('hidden');
            dataSection.classList.remove('hidden');
        }
        function createScorecards() {
            scorecardContainer.innerHTML = '';
            SCORECARD_3PLS.forEach(pl => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow';
                card.innerHTML = `
                    <h3 class="text-sm font-medium text-gray-500 truncate">${pl === 'Total Orders' ? 'Tổng Đơn Hàng' : pl}</h3>
                    <p id="scorecard-count-${pl.replace(/ /g, '-')}" class="mt-1 text-3xl font-semibold text-gray-900">0</p>
                `;
                scorecardContainer.appendChild(card);
            });
        }
        function updateScorecards(dataForScorecards) {
            SCORECARD_3PLS.forEach(pl => {
                let count;
                if (pl === 'Total Orders') {
                    count = dataForScorecards.length;
                } else {
                    count = dataForScorecards.filter(item => item['New 3PL'] === pl).length;
                }
                const countEl = document.getElementById(`scorecard-count-${pl.replace(/ /g, '-')}`);
                if (countEl) {
                    countEl.textContent = count.toLocaleString('vi-VN');
                }
            });
        }

        function populate3PLFilter() {
            const unique3PLs = [...new Set(processedData.map(item => item['New 3PL']))].sort();
            filter3PL.innerHTML = '<option value="">Tất cả 3PL</option>';
            unique3PLs.forEach(pl => {
                if (pl && pl !== 'N/A') {
                    const option = document.createElement('option');
                    option.value = pl;
                    option.textContent = pl;
                    filter3PL.appendChild(option);
                }
            });
        }
        function formatDateToYYYYMMDD(date) {
            if (typeof date === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                date = new Date(excelEpoch.getTime() + (date * 24 * 60 * 60 * 1000));
            } else if (typeof date === 'string') {
                let parsedDate;
                if (date.includes('-')) {
                    parsedDate = new Date(date);
                } else if (date.includes('/')) {
                    const parts = date.split(' ')[0].split('/');
                    if (parts.length === 3) {
                        let year = parseInt(parts[2], 10);
                        let month = parseInt(parts[0], 10);
                        let day = parseInt(parts[1], 10);
                        if (year < 100) {
                            year += 2000;
                        }
                        parsedDate = new Date(year, month - 1, day);
                        if (isNaN(parsedDate.getTime()) || parsedDate.getDate() !== day) {
                            month = parseInt(parts[1], 10);
                            day = parseInt(parts[0], 10);
                            parsedDate = new Date(year, month - 1, day);
                        }
                    }
                }
                if (parsedDate && !isNaN(parsedDate.getTime())) {
                    date = parsedDate;
                } else {
                    return 'N/A';
                }
            }
            if (!(date instanceof Date) || isNaN(date.getTime())) {
                return 'N/A';
            }
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function applyFilters() {
            const selected3PL = filter3PL.value;
            const selectedDate = filterDate.value;

            // 1. Filter processedData theo ngày
            let processedFiltered = [...processedData];
            if (selectedDate) {
                processedFiltered = processedFiltered.filter(item =>
                    item['Shipped Time'] && item['Shipped Time'] !== 'N/A' &&
                    item['Shipped Time'] === selectedDate
                );
            }

            // 2. Gộp với addingData (không filter ngày cho addingData!)
            let currentFilteredData = [...processedFiltered, ...addingData];

            // 3. Nếu filter 3PL, filter luôn trên cả processed + adding
            if (selected3PL) {
                currentFilteredData = currentFilteredData.filter(item => item['New 3PL'] === selected3PL);
            }

            // 4. Cập nhật view và phân trang
            updateScorecards(currentFilteredData);
            filteredViewData = currentFilteredData;
            currentPage = 1;
            renderTable();
            setupPagination();
        }


        function resetFilters() {
            filter3PL.value = '';
            filterDate.value = '';
            applyFilters();
        }
        function displayFormattedDate(dateStringYYYYMMDD) {
            if (dateStringYYYYMMDD === 'N/A') {
                return 'N/A';
            }
            const [year, month, day] = dateStringYYYYMMDD.split('-');
            return `${day}/${month}/${year}`;
        }
        function renderTable() {
            tableBody.innerHTML = '';
            noResultsDiv.classList.add('hidden');
            tableBody.parentElement.classList.remove('hidden');
            if (filteredViewData.length === 0) {
                noResultsDiv.classList.remove('hidden');
                tableBody.parentElement.classList.add('hidden');
                return;
            }
            const pageData = filteredViewData.slice((currentPage - 1) * ROWS_PER_PAGE, currentPage * ROWS_PER_PAGE);
            pageData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="py-3 px-4 border-b border-gray-200 text-sm">${row['New 3PL']}</td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm">${row['LM Tracking No']}</td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm"><span class="bg-green-100 text-green-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${row['Status']}</span></td>
                    <td class="py-3 px-4 border-b border-gray-200 text-sm">${displayFormattedDate(row['Shipped Time'])}</td>
                `;
                tableBody.appendChild(tr);
            });
        }
        function setupPagination() {
            paginationControls.innerHTML = '';
            const pageCount = Math.ceil(filteredViewData.length / ROWS_PER_PAGE);
            const info = document.createElement('div');
            info.className = 'text-sm text-gray-600';
            if (filteredViewData.length === 0) {
                info.textContent = 'Không có kết quả nào';
            } else {
                const startItem = (currentPage - 1) * ROWS_PER_PAGE + 1;
                const endItem = Math.min(currentPage * ROWS_PER_PAGE, filteredViewData.length);
                info.textContent = `Hiển thị ${startItem}-${endItem} trên tổng số ${filteredViewData.length} kết quả`;
            }
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'flex items-center space-x-1';
            if (pageCount > 1) {
                buttonsContainer.appendChild(createPaginationButton('Trước', currentPage > 1, () => {
                    currentPage--; renderTable(); setupPagination();
                }));
                const maxPageButtons = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
                let endPage = Math.min(pageCount, startPage + maxPageButtons - 1);
                if (endPage - startPage + 1 < maxPageButtons) {
                    startPage = Math.max(1, endPage - maxPageButtons + 1);
                }
                if (startPage > 1) {
                    buttonsContainer.appendChild(createPaginationButton('...', true, () => {}));
                }
                for (let i = startPage; i <= endPage; i++) {
                    buttonsContainer.appendChild(createPaginationButton(i, true, () => {
                        currentPage = i; renderTable(); setupPagination();
                    }, i === currentPage));
                }
                if (endPage < pageCount) {
                    buttonsContainer.appendChild(createPaginationButton('...', true, () => {}));
                }
                buttonsContainer.appendChild(createPaginationButton('Sau', currentPage < pageCount, () => {
                    currentPage++; renderTable(); setupPagination();
                }));
            }
            paginationControls.appendChild(info);
            paginationControls.appendChild(buttonsContainer);
        }
        function createPaginationButton(text, enabled, onClick, isActive = false) {
            const button = document.createElement('button');
            button.textContent = text;
            button.disabled = !enabled;
            let baseClasses = 'px-3 py-1 rounded-md text-sm font-medium transition-colors';
            if (isActive) {
                button.className = `${baseClasses} bg-blue-500 text-white`;
            } else if (!enabled) {
                button.className = `${baseClasses} bg-gray-200 text-gray-400 cursor-not-allowed`;
            } else {
                button.className = `${baseClasses} bg-white text-gray-700 hover:bg-gray-100 border border-gray-300`;
            }
            button.addEventListener('click', onClick);
            return button;
        }
        function formatDate(date) {
            if (typeof date === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                date = new Date(excelEpoch.getTime() + (date * 24 * 60 * 60 * 1000));
            } else if (!(date instanceof Date) || isNaN(date)) {
                return 'N/A';
            }
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        // Trong hàm handleOrderRemoval, sửa dòng alert bị lỗi
        function handleOrderRemoval() {
            const trackingNumbersToRemove = new Set(removalTextarea.value.split('\n').map(tn => tn.trim()).filter(tn => tn));
            if (trackingNumbersToRemove.size === 0) {
                alert('Vui lòng nhập ít nhất một mã đơn hàng.');
                return;
            }
            // Đếm số remove theo 3PL
            trackingNumbersToRemove.forEach(trackingNo => {
                const order = processedData.find(row => row['LM Tracking No'] === trackingNo);
                if (order) {
                    const pl = order['New 3PL'];
                    if (!removedCountBy3PL[pl]) removedCountBy3PL[pl] = 0;
                    removedCountBy3PL[pl]++;
                }
            });
            // Remove khỏi processedData
            processedData = processedData.filter(row => !trackingNumbersToRemove.has(row['LM Tracking No']));
            applyFilters();
            populate3PLFilter();
            removeOrderModal.classList.add('hidden');
            removalTextarea.value = '';
            updateSummaryTable(); // Update lại bảng summary
            alert(`${trackingNumbersToRemove.size} đơn hàng đã được xoá.`);
        }

        function updateSummaryTable() {
            document.getElementById('summary-section').classList.remove('hidden');

            // Lấy ngày đã chọn hoặc ngày hiện tại
            let dayStr;
            if (filterDate && filterDate.value) {
                const [yyyy, mm, dd] = filterDate.value.split('-');
                dayStr = `${dd}/${mm}/${yyyy}`;
            } else {
                const today = new Date();
                dayStr = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
            }
            document.getElementById('summary-title').textContent = `Report handover to 3PLs - ${dayStr}`;

            // Lấy data đang filter + các order add tay chưa có trong filter
            let summaryData = [...filteredViewData];
            addingData.forEach(row => {
                if (!summaryData.some(x => x['LM Tracking No'] === row['LM Tracking No'])) {
                    summaryData.push(row);
                }
            });

            // Tính tổng số order theo 3PL trên summaryData
            const countBy3PL = {};
            let totalOrders = 0;
            summaryData.forEach(row => {
                const pl = row['New 3PL'];
                if (!countBy3PL[pl]) countBy3PL[pl] = 0;
                countBy3PL[pl]++;
                totalOrders++;
            });

            const tbody = document.getElementById('summary-tbody');
            let totalRemoved = 0;
            const rowsHtml = []; 

            Object.keys(countBy3PL).sort().forEach(pl => {
                const orderCount = countBy3PL[pl];
                const percent = totalOrders > 0 ? (orderCount / totalOrders * 100).toFixed(1) + '%' : '0.0%';
                const removed = removedCountBy3PL[pl] || 0;
                totalRemoved += removed;
                let reasonInput = `<input type="text" class="w-full min-w-[200px] max-w-[800px] p-1 border border-gray-300 rounded text-xs" placeholder="Lý do remove"
                                        value="${removedReasonBy3PL[pl] || ''}" 
                                        oninput="removedReasonBy3PL['${pl}']=this.value" />`;
                rowsHtml.push(`
                    <tr>
                        <td class="py-2 px-4 border-b w-[170px]">${pl}</td>
                        <td class="py-2 px-4 border-b text-right w-[120px]">${orderCount.toLocaleString('vi-VN')}</td>
                        <td class="py-2 px-4 border-b text-right w-[120px]">${percent}</td>
                        <td class="py-2 px-4 border-b text-right w-[120px]">${removed}</td>
                        <td class="py-2 px-4 border-b min-w-[210px]">${removed > 0 ? reasonInput : ''}</td>
                    </tr>
                `);
            });
            tbody.innerHTML = rowsHtml.join('');
            document.getElementById('total-orders').textContent = totalOrders.toLocaleString('vi-VN');
            document.getElementById('total-removed').textContent = totalRemoved.toLocaleString('vi-VN');
        }

        function handleOrderAdding() {
            const trackingNumbersToAdd = new Set(
                addTrackingTextarea.value.split('\n').map(tn => tn.trim()).filter(Boolean)
            );
            if (trackingNumbersToAdd.size === 0) {
                alert('Vui lòng nhập ít nhất một mã đơn hàng.');
                return;
            }

            // Lấy data của order từ allData (vì processedData có thể đã bị remove trước đó)
            trackingNumbersToAdd.forEach(trackingNo => {
                // Kiểm tra nếu đã có trong addingData thì bỏ qua
                if (addingData.some(item => item['LM Tracking No'] === trackingNo)) return;

                // Tìm order trong allData
                const foundOrder = allData.find(item => String(item['LM Tracking No']) === trackingNo);
                if (foundOrder) {
                    // Đổi format để giống processedData
                    addingData.push({
                        'New 3PL': rename3PL(foundOrder['New 3PL'] || 'N/A', foundOrder['Shipped by']),
                        'LM Tracking No': String(foundOrder['LM Tracking No'] || 'N/A'),
                        'Status': String(foundOrder['Status']),
                        'Shipped Time': foundOrder['Shipped Time'] ? formatDateToYYYYMMDD(foundOrder['Shipped Time']) : 'N/A',
                        'Shipped by': String(foundOrder['Shipped by'] || '')
                    });
                    // Nếu order này còn trong processedData, thì xóa ra (tránh duplicate)
                    processedData = processedData.filter(row => row['LM Tracking No'] !== trackingNo);
                }
            });
            applyFilters(); // Để update lại table
            addOrderModal.classList.add('hidden');
            addTrackingTextarea.value = '';
            alert(`${trackingNumbersToAdd.size} đơn hàng đã được thêm lại.`);
        }

        function handleOrderAddingCK() {
            const trackingNumbersToAdd = new Set(
                addCkTrackingTextarea.value.split('\n').map(tn => tn.trim()).filter(Boolean)
            );
            if (trackingNumbersToAdd.size === 0) {
                alert('Vui lòng nhập ít nhất một mã đơn hàng.');
                return;
            }

            let addedCount = 0;
            let skippedCount = 0;

            // Lấy data của order từ allData (vì processedData có thể đã bị remove trước đó)
            trackingNumbersToAdd.forEach(trackingNo => {
                // Kiểm tra nếu đã có trong addingData thì bỏ qua
                if (addingData.some(item => item['LM Tracking No'] === trackingNo)) {
                    skippedCount++;
                    return;
                }

                // Tìm order trong allData
                const foundOrder = allData.find(item => String(item['LM Tracking No']) === trackingNo);
                if (foundOrder) {
                    // Chỉ thêm các đơn có "GHN - Hàng Cồng Kềnh" và chuyển thành AhamoveCK
                    const original3PL = foundOrder['New 3PL'] || 'N/A';
                    if (original3PL === 'GHN - Hàng Cồng Kềnh') {
                        // Đổi format để giống processedData, nhưng force New 3PL thành AhamoveCK
                        addingData.push({
                            'New 3PL': 'AhamoveCK',
                            'LM Tracking No': String(foundOrder['LM Tracking No'] || 'N/A'),
                            'Status': String(foundOrder['Status']),
                            'Shipped Time': foundOrder['Shipped Time'] ? formatDateToYYYYMMDD(foundOrder['Shipped Time']) : 'N/A',
                            'Shipped by': String(foundOrder['Shipped by'] || '')
                        });
                        // Nếu order này còn trong processedData, thì xóa ra (tránh duplicate)
                        processedData = processedData.filter(row => row['LM Tracking No'] !== trackingNo);
                        addedCount++;
                    } else {
                        skippedCount++;
                    }
                } else {
                    skippedCount++;
                }
            });

            applyFilters(); // Để update lại table
            addOrderCkModal.classList.add('hidden');
            addCkTrackingTextarea.value = '';
            
            if (skippedCount > 0) {
                alert(`${addedCount} đơn hàng CK đã được thêm vào AhamoveCK.\n${skippedCount} đơn hàng được bỏ qua (không phải GHN - Hàng Cồng Kềnh hoặc đã tồn tại).`);
            } else {
                alert(`${addedCount} đơn hàng CK đã được thêm vào AhamoveCK.`);
            }
        }


        // Hàm exportToExcel (giữ nguyên từ phiên bản trước, đảm bảo định nghĩa đúng)
        function exportToExcel() {
            if (filteredViewData.length === 0) {
                alert("Không có dữ liệu để xuất.");
                return;
            }
            const selectedDate = filterDate.value;
            const today = new Date();
            const defaultDate = `${today.getUTCFullYear()}-${String(today.getUTCMonth() + 1).padStart(2, '0')}-${String(today.getUTCDate()).padStart(2, '0')}`;
            const exportDate = selectedDate || defaultDate;
            const dataBy3PL = {};
            filteredViewData.forEach(item => {
                const pl = item['New 3PL'];
                if (pl && pl !== 'N/A') {
                    if (!dataBy3PL[pl]) {
                        dataBy3PL[pl] = [];
                    }
                    // Chỉ lấy các field cần export (remove 'Shipped by')
                    dataBy3PL[pl].push({
                        'New 3PL': item['New 3PL'],
                        'LM Tracking No': item['LM Tracking No'],
                        'Status': item['Status'],
                        'Shipped Date': item['Shipped Time']
                    });
                }
            });
            Object.keys(dataBy3PL).forEach(pl => {
                const dataToExport = dataBy3PL[pl];
                if (dataToExport.length > 0) {
                    const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, `${pl}_Orders`);
                    const fileName = `${pl.replace(/ /g, '_')}_${dataToExport.length}_${exportDate}.xlsx`;
                    XLSX.writeFile(workbook, fileName);
                }
            });
            if (Object.keys(dataBy3PL).length === 0) {
                alert("Không có dữ liệu để xuất.");
            }
        }


        function getNextDay(dateStr) {
            let date;
            if (dateStr) {
                date = new Date(dateStr);
            } else {
                date = new Date();
            }
            date.setUTCDate(date.getUTCDate() + 1);
            const day = String(date.getUTCDate()).padStart(2, '0');
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            const year = date.getUTCFullYear();
            return `${day}/${month}/${year}`;
        }
        function openTextToEmailModal() {
            if (filteredViewData.length === 0) {
                alert("Không có dữ liệu để tạo nội dung email.");
                return;
            }
            plButtonsContainer.innerHTML = '';
            const selectedDate = filterDate.value;
            const displayDate = selectedDate ? displayFormattedDate(selectedDate) : formatDate(new Date());
            const nextDay = getNextDay(selectedDate);
            const valid3PLs = SCORECARD_3PLS.filter(pl => pl !== 'Total Orders');
            valid3PLs.forEach(pl => {
                const count = filteredViewData.filter(item => item['New 3PL'] === pl).length;
                if (count > 0) {
                    const button = document.createElement('button');
                    button.className = 'bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition-colors w-full text-left';
                    button.textContent = `${pl} (${count} đơn)`;
                    button.addEventListener('click', () => {
                        const text = `Dear ${pl} & Logistics Team\n\nKho Shopee gửi file bàn giao ${pl} ngày ${displayDate} như sau:\n- Số kiện bàn giao: ${count} đơn\n\nNhờ Team vui lòng xác nhận trước 15h ${nextDay}, nếu không có vấn đề, kho xin chốt\nThank All`;
                        navigator.clipboard.writeText(text).then(() => {
                            alert(`Đã sao chép nội dung email cho ${pl}`);
                        }).catch(err => {
                            console.error('Lỗi khi sao chép:', err);
                            alert('Lỗi khi sao chép, vui lòng thử lại.');
                        });
                    });
                    plButtonsContainer.appendChild(button);
                }
            });
            if (plButtonsContainer.innerHTML === '') {
                plButtonsContainer.innerHTML = '<p class="text-sm text-gray-600">Không có dữ liệu 3PL để tạo nội dung email.</p>';
            }
            textToEmailModal.classList.remove('hidden');
        }
    </script>
    <!-- <script>
        const params = new URLSearchParams(window.location.search);
        let name = params.get("name");

        if (!name) {
            // Nếu không có name → quay lại trang login
            window.location.href = "index.html";
        } else {
            try {
                name = decodeURIComponent(decodeURIComponent(name));
            } catch (e) {
                console.error("Decode lỗi:", e);
        }

        // ✅ Lưu vào localStorage
        // Sau khi decode name thành công
        localStorage.setItem("seatalk_name", name);
        
        // ⏱ Chỉ lưu login_time nếu chưa có
        if (!localStorage.getItem("seatalk_login_time")) {
            localStorage.setItem("seatalk_login_time", Date.now());
        }
        }
</script> -->
</body>
</html>
