<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>B√°o l·ªói</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>üí∏üí∏üí∏Tools ƒë∆∞·ª£c build t·ª´ quoctrung.nguyen@shopee.com
¬†   <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
</head>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin-left: 60px;
        background-color: #f9fafb;
        color: #333;
        font-size: 18px;
    }

    h1 {
        text-align: center;
        font-size: 40px;
        font-weight: bold;
        color: #2c3e50;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        border-bottom: 3px solid #3498db;
        display: inline-block;
        padding-bottom: 10px;
    }
    
    h2 {
        font-size: 32px;
        color: #2c3e50;
    }
    
    .form-row {
        display: flex;
        align-items: center;
        vertical-align: top;
        margin-top: 20px;
    }
    
    .form-row label {
        width: 240px;
        margin: 0;
        font-weight: 600;
        color: #34495e;
        font-weight: bold;
        font-size: 20px;
    }
    
    .form-row input,
    .form-row select {
        flex: 1;
        width: 450px;
        padding: 12px;
        font-size: 18px;
        border: 1px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    
    input:focus, select:focus {
        border-color: #007BFF;
        box-shadow: 0 0 6px rgba(0, 123, 255, 0.3);
        outline: none;
    }
    
    button {
        padding: 20px 40px;
        font-size: 22px;
        font-weight: bold;
        cursor: pointer;
        background-color: green;
        color: white;
        border: none;
        border-radius: 8px;
        margin-top: 10px;
        transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
        width: 700px;
    }
    
    button:hover {
        background-color: #0056b3;
        transform: scale(1.03);
    }
    
    canvas {
        display: none;
        width: 794px;
        height: 1123px;
        background: white;
        border-radius: 8px;
        margin-top: 40px;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #fff;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    thead {
        background-color: #2c3e50;
        color: white;
    }

    th, td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    tbody tr:hover {
        background-color: #f4f8fb;
        transition: background-color 0.3s ease;
    }

    .button-container button {
        background-color: #2c3e50;
        color: white;
        border: 1px solid #2c3e50;
        padding: 10px 22px;
        margin-left: 10px;
        border-radius: 6px;
        font-size: 25px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        width: 300px;
    }

    .button-container button:hover {
        background-color: white;
        color: #2c3e50;
        border-color: #2c3e50;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }

    #errorTextDisplay {
        font-weight: bold;
        color: #c0392b;
        font-size: 80px;
    }

    .right-frame {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin-left: 210px;
        margin-top: 20px;
        width: 30%;
    }

    .highlight-row {
        background-color: yellow;
        font-weight: bold;
        font-size: 25px;
    }
</style>
<body>

    <div class="header-bar">
        <h1>Record Damage</h1>
        <div id="download-container"></div>
        
        <div class="button-container">
            <button onclick="showForm()"><i class="fa-solid fa-pen-to-square"></i> B√°o l·ªói</button>
        </div>
    </div>
    
    <div id="formFrame">
        <h2>B√°o l·ªói</h2>
        <div class="form-row">
            <div class="left-frame">
                <form onsubmit="return false;">
                    <div class="form-row">
                        <label for="warehouse">Kho:</label>
                        <select id="warehouse">
                            <option value="" disabled selected>--Ch·ªçn kho--</option>
                            <option value="VNS">VNS</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <label for="task" >Task:</label>
                        <select id="task" onchange="showErrorMapTable()">
                            <option value="" disabled selected>--Ch·ªçn t√°c v·ª•--</option>
                            <option value="Consignment">DF/Consignment</option>
                            <option value="Outright">DA/Outright</option>
                            <option value="Vinamilk">Vinamilk</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label for="station">Nh·∫≠p Location:</label>
                        <input type="text" id="station" onkeydown="focusNext(event, 'employee')" placeholder="From Location">
                    </div>

                    <div class="form-row">
                        <label for="employee">T√™n nh√¢n vi√™n:</label>
                        <input type="text" id="employee" onkeydown="focusNext(event, 'errorCode')" placeholder="Nh·∫≠p t√™n nh√¢n vi√™n">
                    </div>

                    <div class="form-row">
                        <label for="errorCode">M√£ l·ªói: (B·∫•m Enter)</label>
                        <input type="number" id="errorCode" onkeydown="handleErrorCode(event)" placeholder="Nh·∫≠p m√£ l·ªói">
                    </div>

                    <div style="display: none;" class="form-row">
                        <label></label>
                        <div id="errorTextDisplay"></div>
                    </div>

                    <div class="form-row">
                        <label for="orderCode">SKU / ID</label>
                        <input type="text" id="orderCode">
                    </div>

                    <div class="form-row">
                        <label for="description">M√¥ t·∫£ chi ti·∫øt:</label>
                        <input type="text" id="description">
                    </div>
                </form>
                <button type="button" onclick="reportError()">B√°o l·ªói</button>
            </div>

            <div class="right-frame">
            </div>
        </div>
    </div>
    
    <canvas id="a4Canvas" width="794" height="1123"></canvas>
        
    <script>
        function showForm() {
            document.getElementById("formFrame").style.display = "block";
        }

        document.getElementById("orderCode").addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                reportError();
            }
        });

        let cookie_arr = [];
        let backendBaseUrl = "";

        async function loadCookieArray() {
            const url = "https://script.google.com/macros/s/AKfycbw4AykhEv2AmxCt_23XJGB7Rt1zzchWqKF7RinMWnTKTG9UG8h2tk99SjHsLnZkU8Cn/exec";
            try {
                const res = await fetch(url);
                cookie_arr = await res.json();
                backendBaseUrl = cookie_arr[11][1];
                const a = document.createElement("a");
                a.href = `${backendBaseUrl}/downloads/print_hotkey.7z`;
                a.download = '';
                a.textContent = "Format";
                a.style.display = "inline-block";
                a.style.marginTop = "20px";
                document.getElementById("download-container").appendChild(a);
            } catch (err) {
                console.log("err");
            }
        }

        loadCookieArray();

        const checking = {
            1: 'BAO B√å X·∫§U/D∆†',
            2: 'M√ìP S·∫¢N PH·∫®M',
            3: 'M·∫§T H·ªòP/SP B√äN TRONG',
            4: 'B·ªÇ V·ª† +X√å CH·∫¢Y',
            5: 'C·∫¨N/H·∫æT DATE',
            6: 'THI·∫æU H√ÄNG',
            7: 'B·∫æ/M·∫§T N·∫ÆP',
            8: 'G√ÉY/ M·∫§T V√íI',
            9: 'R√ÅCH BAO B√å',
            10: 'L·ªñI NH√Ä S·∫¢N XU·∫§T'};

        const packing = {
            1: 'BAO B√å X·∫§U/D∆†', 2: 'M√ìP S·∫¢N PH·∫®M', 3: 'M·∫§T H·ªòP/SP B√äN TRONG', 4: 'B·ªÇ V·ª† +X√å CH·∫¢Y', 5: 'C·∫¨N/H·∫æT DATE', 6: 'THI·∫æU H√ÄNG', 7: 'B·∫æ/M·∫§T N·∫ÆP', 8: 'G√ÉY/ M·∫§T V√íI', 9: 'R√ÅCH BAO B√å', 10: 'L·ªñI NH√Ä S·∫¢N XU·∫§T'
        };

        const audit = {
            1: 'BAO B√å X·∫§U/D∆†', 2: 'M√ìP S·∫¢N PH·∫®M', 3: 'M·∫§T H·ªòP/SP B√äN TRONG', 4: 'B·ªÇ V·ª† +X√å CH·∫¢Y', 5: 'C·∫¨N/H·∫æT DATE', 6: 'THI·∫æU H√ÄNG', 7: 'B·∫æ/M·∫§P N·∫ÆP', 8: 'G√ÉY/ M·∫§T V√íI', 9: 'R√ÅCH BAO B√å', 10: 'L·ªñI NH√Ä S·∫¢N XU·∫§T'
        };

        function focusNext(event, nextId) {
            if (event.key === 'Enter') {
                document.getElementById(nextId).focus();
                event.preventDefault();
            }
        }

        function handleErrorCode(event) {
            if (event.key === 'Enter') {
                const task = document.getElementById("task").value;
                const code = parseInt(document.getElementById("errorCode").value);
                const map = task === 'Consignment' ? checking : task === 'Outright' ? packing : audit;
                const errorText = map[code];
                const display = document.getElementById("errorTextDisplay");

                const rows = document.querySelectorAll('.right-frame table tbody tr');
                rows.forEach(row => row.classList.remove('highlight-row'));

                if (errorText) {
                    display.textContent = `‚Üí ${errorText}`;
                    document.getElementById("orderCode").focus();

                    rows.forEach(row => {
                        const cellCode = parseInt(row.cells[0].textContent);
                        if (cellCode === code) {
                            row.classList.add('highlight-row');
                        }
                    });
                } else {
                    alert("M√£ l·ªói kh√¥ng h·ª£p l·ªá");
                    document.getElementById("errorCode").value = '';
                    display.textContent = '';
                    document.getElementById("errorCode").focus();
                }
                event.preventDefault();
            }
        }

        function generateTaskId() {
            const now = new Date();
            const mmddyy = now.toLocaleDateString('en-GB').split('/').join('').slice(0, 6);
            const hhmmss = now.toTimeString().split(' ')[0].split(':').join('');
            const random = Math.random().toString(36).substring(2, 7).toUpperCase();
            return `T${mmddyy}${hhmmss}${random}`;
        }

        function getFormattedNow() {
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = String(now.getMonth() + 1).padStart(2, '0');
            const dd = String(now.getDate()).padStart(2, '0');
            const hh = String(now.getHours()).padStart(2, '0');
            const mi = String(now.getMinutes()).padStart(2, '0');
            const ss = String(now.getSeconds()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`;
        }

        async function reportError() {
            const task = document.getElementById("task").value;
            const errorCode = document.getElementById("errorCode").value;
            const errorMap = task === 'Consignment' ? checking : task === 'Outright' ? packing : audit;
            const errorText = errorMap[errorCode];
            const datetime = getFormattedNow();

            let orderCode = "";
            const taskId = generateTaskId();
            const canvas = document.getElementById("a4Canvas");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const warehouse = document.getElementById("warehouse").value;
            const station = document.getElementById("station").value;
            const employee = document.getElementById("employee").value;
            const orderCodeBase = document.getElementById("orderCode").value;
            const description = document.getElementById("description").value;

            if (!warehouse) {
                alert("Vui l√≤ng ch·ªçn kho.");
                return;
            }

            if (!task) {
                alert("Vui l√≤ng ch·ªçn t√°c v·ª•.");
                return;
            }

            if (!station) {
                alert("Vui l√≤ng nh·∫≠p v·ªã tr√≠ Location.");
                document.getElementById("station").focus();
                return;
            }

            if (!employee) {
                alert("Vui l√≤ng nh·∫≠p t√™n nh√¢n vi√™n.");
                document.getElementById("employee").focus();
                return;
            }

            if (!errorText) {
                alert("M√£ l·ªói kh√¥ng h·ª£p l·ªá");
                document.getElementById("errorCode").value = '';
                document.getElementById("errorCode").focus();
                return;
            }

            if (orderCodeBase.trim() === "") {
                orderCode = "-";
            } else {
                orderCode = orderCodeBase;
            }

            const body = {
                taskId,
                warehouse,
                task,
                station,
                employee,
                orderCode,
                errorText,
                description
            };

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "#0a4687";
            ctx.font = "bold 38px Arial";
            ctx.textAlign = "center";
            ctx.fillText("PHI·∫æU B√ÅO L·ªñI", canvas.width / 2, 60);
            ctx.font = "italic 20px Arial";
            ctx.fillText("Record Damage ", canvas.width / 2, 90);

            ctx.textAlign = "left";
            ctx.strokeStyle = "#dadada";
            ctx.lineWidth = 2;
            ctx.strokeRect(40, 110, 670, 130);
            ctx.font = "bold 22px Arial";
            ctx.fillStyle = "#222";
            ctx.fillText(`Kho: ${warehouse}`, 60, 150);
            ctx.fillText(`Task: ${task}`, 390, 150);
            ctx.fillText(`Location: ${station}`, 60, 175);
            ctx.fillText(`Nh√¢n vi√™n: ${employee}`, 390, 175);
            ctx.font = "bold 18px Arial";
            ctx.fillStyle = "#444";
            ctx.fillText(`Th·ªùi gian: ${datetime}`, 60, 225);

            ctx.fillStyle = "#d32f2f";
            ctx.font = "bold 30px Arial";
            ctx.fillText(`L·ªñI: ${errorText}`, 60, 280);

            ctx.fillStyle = "#222";
            const barcodeCanvas1 = document.createElement("canvas");
            JsBarcode(barcodeCanvas1, taskId, { format: "CODE128", width: 2, height: 60, displayValue: true });
            ctx.drawImage(barcodeCanvas1, 60, 310);

            const barcodeCanvas2 = document.createElement("canvas");
            JsBarcode(barcodeCanvas2, orderCode, { format: "CODE128", width: 2, height: 40, displayValue: true });
            ctx.drawImage(barcodeCanvas2, 60, 420);

            ctx.font = "bold 42px Arial";
            ctx.fillStyle = "#222";
            ctx.textAlign = "left";
            ctx.fillText(`${orderCode}`, 60, 540);

            ctx.font = "bold 40px Arial";
            let desc = description || "-";
            let words = desc.split(' ');
            let lines = [];
            let line = '';

            for (let n = 0; n < words.length; n++) {
                let testLine = line + words[n] + ' ';
                let metrics = ctx.measureText(testLine);
                let testWidth = metrics.width;
                if (testWidth > 620 && n > 0) {
                    lines.push(line.trim());
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line.trim());

            let numDescLines = lines.length;
            let descLineHeight = 24;
            let minBoxHeight = 90;
            let boxDescHeight = Math.max(minBoxHeight, 40 + descLineHeight * numDescLines);

            let boxDescStartY = 580;

            ctx.strokeStyle = "#1976d2";
            ctx.lineWidth = 2;
            ctx.strokeRect(40, boxDescStartY, 670, boxDescHeight);

            ctx.font = "italic 22px Arial";
            ctx.fillStyle = "#1976d2";
            ctx.fillText("M√¥ t·∫£ chi ti·∫øt:", 60, boxDescStartY + 30);

            ctx.font = "bold 30px Arial";
            ctx.fillStyle = "#111";
            let startY = boxDescStartY + 60;
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], 60, startY + i * descLineHeight);
            }

            ctx.font = "italic 15px Arial";
            ctx.fillStyle = "#aaa";
            ctx.textAlign = "right";
            ctx.fillText("Generated by WMS System", canvas.width - 100, canvas.height - 100);
            ctx.textAlign = "left";

            const imageData = canvas.toDataURL("image/png");
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "pt", "a4");
            pdf.addImage(imageData, "PNG", 0, 0, 595, 895);
            const blob = pdf.output("bloburl");
            window.open(blob, "_blank");

            document.getElementById("errorCode").value = '';
            document.getElementById("errorTextDisplay").textContent = '';
            document.getElementById("orderCode").value = '';
            document.getElementById("description").value = '';

            document.getElementById("errorCode").focus();

            const res = await fetch(`${backendBaseUrl}/api/submit-ob-error`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(body)
            });

            const result = await res.json();
            if (result.success) {
                console.log("G·ª≠i d·ªØ li·ªáu th√†nh c√¥ng!");
            } else {
                console.log("G·ª≠i th·∫•t b·∫°i!");
            }
        }

        function showErrorMapTable() {
            const task = document.getElementById("task").value;
            const map = task === 'Consignment' ? checking : task === 'Outright' ? packing : audit;
            const rightFrame = document.querySelector('.right-frame');
            let html = '<table border="1" cellpadding="5" cellspacing="0"><thead><tr><th>M√£</th><th>M√¥ t·∫£ l·ªói</th></tr></thead><tbody>';
            for (const code in map) {
                html += `<tr><td>${code}</td><td>${map[code]}</td></tr>`;
            }
            html += '</tbody></table>';
            rightFrame.innerHTML = html;
        }
    </script>
</body>
</html>
