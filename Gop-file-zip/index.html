<!DOCTYPE html>
<html>
<head>
    <title>TOOLS G·ªòP NHI·ªÄU FILES</title>
    <style>
        /* M√†u ch·ªß ƒë·∫°o theo giao di·ªán g·ªëc (Be nh·∫°t, Tr·∫Øng, Cam, Xanh) */
        body {
            background-color: #FDF5E6; /* M√†u Be nh·∫°t */
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }

        h1 {
            color: #E67E22; /* M√†u Cam/ƒê·ªè Cam ƒë·∫≠m */
            text-align: center;
            margin: 20px 0 10px 0;
            padding-bottom: 10px;
            width: 90%;
            max-width: 800px;
            font-size: 2em;
            font-weight: 700;
        }

        .container {
            width: 90%;
            max-width: 700px;
            background-color: #FFFFFF;
            padding: 30px;
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
            margin-top: 20px;
        }

        .step-group {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #E6E6E6; /* Vi·ªÅn nh·∫π */
            border-radius: 8px;
            background-color: #F7F7F7; /* N·ªÅn x√°m nh·∫π cho t·ª´ng b∆∞·ªõc */
        }
        
        /* Ti√™u ƒë·ªÅ b∆∞·ªõc */
        .step-group h3 {
            color: #34495E;
            font-size: 1.1em;
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
        }

        label {
            color: #34495E; 
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
            font-size: 1em;
        }

        input[type="file"], input[type="date"] {
            width: 100%;
            border: 1px solid #BDC3C7;
            border-radius: 6px;
            padding: 10px;
            background-color: #fff;
            margin-bottom: 10px;
            box-sizing: border-box; /* Quan tr·ªçng ƒë·ªÉ padding kh√¥ng l√†m tƒÉng width */
            font-size: 1em;
        }
        
        /* N√∫t G·ªôp (M√ÄU XANH ƒê·∫¨M - PRIMARY) */
        button {
            width: 100%;
            background-color: #2C3E50; /* Xanh ƒê·∫≠m Navy */
            color: #FFFFFF;
            border: none;
            padding: 14px 25px;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.1em;
            transition: background-color 0.3s ease, transform 0.1s, box-shadow 0.3s;
            margin-top: 10px;
            box-shadow: 0 4px #212F3D; 
        }

        button:hover {
            background-color: #212F3D;
            transform: translateY(2px);
            box-shadow: 0 2px #212F3D;
        }
        
        /* N√∫t Export (M√ÄU CAM/ƒê·ªé CAM - SECONDARY/HIGHLIGHT) */
        #exportButton {
            background-color: #F39C12 !important; /* Cam M·ªõi */
            box-shadow: 0 4px #E67E22 !important; /* ƒê·ªè Cam ƒê·∫≠m h∆°n */
            color: #FFFFFF !important;
        }

        #exportButton:hover {
            background-color: #E67E22 !important;
            box-shadow: 0 2px #E67E22 !important;
        }

        #resultInfo {
            margin-top: 30px;
            font-weight: 600;
            color: #34495E;
            background-color: #ECF0F1; /* N·ªÅn th√¥ng b√°o nh·∫π */
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #3498DB; /* M√†u xanh bi·ªÉn cho th√¥ng b√°o th√†nh c√¥ng */
        }
        
        #resultInfo h2 {
            color: #34495E;
            font-size: 1.3em;
            margin-top: 0;
            margin-bottom: 10px;
        }

        #resultInfo p {
            font-size: 0.95em;
            line-height: 1.4;
        }
        
        /* ƒê·∫£m b·∫£o n·ªôi dung th√¥ng b√°o L·ªåC V√Ä T·ªîNG H·ª¢P n·ªïi b·∫≠t */
        #resultInfo p strong, #resultInfo .highlight {
            color: #E67E22; /* Cam */
            font-weight: 800;
            background-color: #FDEBD0; /* N·ªÅn v√†ng nh·∫°t */
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        #resultInfo ul {
            list-style: none; 
            padding-left: 0;
            font-weight: normal;
            font-size: 0.9em;
            color: #555;
            margin-top: 10px;
        }
        
        #resultInfo ul li {
            padding-left: 10px;
            margin-bottom: 5px;
        }

        .error-message {
             color: #C0392B; 
             border-left: 3px solid #E74C3C; 
             padding-left: 10px;
             margin-top: 15px;
             font-weight: 600;
        }
        
        .modal {
            /* Gi·ªØ nguy√™n style modal */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
</head>
<body>
    <h1>TOOLS G·ªòP NHI·ªÄU FILES (Version 2.0)</h1>
    <p class="text-gray-600">Tools ƒë∆∞·ª£c built b·ªüi Nguy·ªÖn Trung, c√≥ g√¨ th·∫Øc m·∫Øc li√™n h·ªá quoctrung.nguyen@shopee.com.</p>
    <div class="container">
        <div class="step-group">
            <h3>B∆∞·ªõc 1: Ch·ªçn nhi·ªÅu File Excel/CSV c·∫ßn g·ªôp:</h3>
            <input type="file" id="storageFiles" accept=".xlsx, .xls, .csv" multiple> 
            
            <button onclick="processFiles()">G·ªòP ALL D·ªÆ LI·ªÜU</button>
        </div>
        
        <div class="step-group">
            <h3>B∆∞·ªõc 2: Filter D·ªØ li·ªáu ƒë√£ g·ªôp theo Ng√†y **"Create Time"**:</h3>
            <input type="date" id="dateFilter" onchange="applyDateFilter()" disabled>
            
            <button onclick="exportResult()" id="exportButton" disabled>EXPORT K·∫æT QU·∫¢</button>
        </div>

        <div id="resultInfo">
            Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c t·∫£i l√™n. Vui l√≤ng ch·ªçn file v√† nh·∫•n <strong class="highlight">G·ªòP ALL D·ªÆ LI·ªÜU</strong>.
        </div>
    </div>

    <div id="customAlert" class="modal" onclick="closeCustomAlert()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <p id="customAlertMessage"></p>
            <button onclick="closeCustomAlert()" class="modal-close">ƒê√≥ng</button>
        </div>
    </div>

    <script>
        // --- LOGIC G·ªòP FILE V√Ä L·ªåC NG√ÄY (GI·ªÆ NGUY√äN) ---
        let originalAllDataRows = []; 
        let filteredDataRows = []; 
        let finalHeaders = []; 
        let isProcessed = false;
        const TARGET_DATE_COLUMN_NAME = "create time"; 
        let dateColumnIndex = -1; 
        
        const resultInfoElement = document.getElementById("resultInfo");
        const exportButton = document.getElementById("exportButton");
        const dateFilterElement = document.getElementById("dateFilter");

        function showCustomAlert(message) {
            document.getElementById("customAlertMessage").innerHTML = message;
            document.getElementById("customAlert").style.display = "block";
        }

        function closeCustomAlert() {
            document.getElementById("customAlert").style.display = "none";
        }
        
        /**
         * L·∫•y ng√†y theo ƒë·ªãnh d·∫°ng YYYY-MM-DD t·ª´ gi√° tr·ªã cell Excel/CSV
         */
        function getLocalISODate(value) {
            let dateObj = null;

            if (value instanceof Date && !isNaN(value)) {
                dateObj = value;
            } else if (typeof value === 'string') {
                let dateStringCleaned = value.trim();

                if (dateStringCleaned.includes('/')) {
                    const parts = dateStringCleaned.split(' ')[0].split('/');
                    if (parts.length === 3 && parts[2].length === 4) {
                        const [dd, mm, yyyy] = parts;
                        dateObj = new Date(`${mm}/${dd}/${yyyy}`);
                    }
                } else if (dateStringCleaned.includes('-')) {
                     const parts = dateStringCleaned.split(' ')[0].split('-');
                     if (parts.length === 3) {
                         if (parts[0].length <= 2 && parts[2].length === 4) {
                             const [dd, mm, yyyy] = parts;
                             dateObj = new Date(`${mm}/${dd}/${yyyy}`);
                         } else if (parts[0].length === 4) {
                            dateObj = new Date(dateStringCleaned);
                         }
                     }
                }
                
                if (!dateObj || isNaN(dateObj.getTime())) {
                    dateObj = new Date(value.trim()); 
                }
            }

            if (dateObj && !isNaN(dateObj.getTime())) {
                const yyyy = dateObj.getFullYear();
                const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                const dd = String(dateObj.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            }

            return null;
        }


        function processSingleFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true }); 
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        
                        const rowsWithDates = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        const fileHeaders = rowsWithDates[0] || [];
                        const dataRows = rowsWithDates.slice(1);
                        
                        if (fileHeaders.length === 0) {
                             return reject({ name: file.name, reason: `File tr·ªëng ho·∫∑c kh√¥ng c√≥ header.`, status: 'failure' });
                        }

                        resolve({ 
                            name: file.name, 
                            count: dataRows.length, 
                            headers: fileHeaders,
                            rows: dataRows, 
                            status: 'success' 
                        });
                    } catch (error) {
                        reject({ name: file.name, reason: `L·ªói khi ƒë·ªçc file. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng.`, status: 'failure' });
                    }
                };
                reader.onerror = function() {
                    reject({ name: file.name, reason: `L·ªói: Kh√¥ng th·ªÉ ƒë·ªçc file.`, status: 'failure' });
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function processFiles() {
            const fileInput = document.getElementById('storageFiles');
            const files = Array.from(fileInput.files);
            
            if (files.length === 0) {
                showCustomAlert("‚ö†Ô∏è Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt file Excel/CSV ƒë·ªÉ g·ªôp.");
                return;
            }

            originalAllDataRows = [];
            filteredDataRows = [];
            finalHeaders = [];
            isProcessed = false;
            dateColumnIndex = -1; 
            exportButton.disabled = true;
            dateFilterElement.disabled = true;
            dateFilterElement.value = '';
            
            resultInfoElement.innerHTML = `ƒêang x·ª≠ l√Ω ${files.length} file... Vui l√≤ng ch·ªù...`;

            let initialTotalCodes = 0;
            let successFiles = [];
            let failureMessages = [];

            const processPromises = files.map(file => processSingleFile(file));

            try {
                const results = await Promise.allSettled(processPromises);
                
                results.forEach(result => {
                    if (result.status === 'fulfilled' && result.value.status === 'success') {
                        const fileData = result.value;
                        successFiles.push(fileData);
                        initialTotalCodes += fileData.count;

                        if (finalHeaders.length === 0) {
                            finalHeaders = fileData.headers;
                            
                            const targetHeader = finalHeaders.findIndex(header => 
                                typeof header === 'string' && header.toLowerCase().trim() === TARGET_DATE_COLUMN_NAME
                            );
                            dateColumnIndex = targetHeader;
                        }
                        
                        originalAllDataRows.push(...fileData.rows);

                    } else if (result.status === 'rejected') {
                        failureMessages.push(result.reason);
                    }
                });
                
                filteredDataRows = [...originalAllDataRows];
                
                updateResultDisplay(successFiles, failureMessages, originalAllDataRows.length);
                isProcessed = true;
                
                const canFilter = originalAllDataRows.length > 0 && dateColumnIndex !== -1;
                exportButton.disabled = originalAllDataRows.length === 0;
                dateFilterElement.disabled = !canFilter; 

                if (originalAllDataRows.length > 0 && dateColumnIndex === -1) {
                    showCustomAlert(`‚ö†Ô∏è G·ªôp th√†nh c√¥ng, nh∆∞ng **Kh√¥ng t√¨m th·∫•y c·ªôt "${TARGET_DATE_COLUMN_NAME.toUpperCase()}"** ƒë·ªÉ k√≠ch ho·∫°t ch·ª©c nƒÉng l·ªçc ng√†y.`);
                } else if (originalAllDataRows.length > 0) {
                    showCustomAlert(`‚úÖ Ho√†n t·∫•t g·ªôp file! T·ªïng **${originalAllDataRows.length}** h√†ng. B·ªô l·ªçc ng√†y ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t.`);
                }

            } catch (error) {
                showCustomAlert("‚ùå L·ªói h·ªá th·ªëng khi x·ª≠ l√Ω c√°c file.");
            }
        }
        
        function applyDateFilter() {
            const filterDate = dateFilterElement.value; // Gi√° tr·ªã l·ªçc: YYYY-MM-DD
            
            if (dateColumnIndex === -1) {
                showCustomAlert(`‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y c·ªôt "${TARGET_DATE_COLUMN_NAME.toUpperCase()}" ƒë·ªÉ √°p d·ª•ng b·ªô l·ªçc.`);
                return;
            }

            if (!filterDate) {
                filteredDataRows = [...originalAllDataRows];
            } else {
                
                filteredDataRows = originalAllDataRows.filter(row => {
                    const cellValue = row[dateColumnIndex]; 
                    const cellDateISO = getLocalISODate(cellValue);
                    
                    return cellDateISO === filterDate;
                });
            }

            updateFilterDisplay(filteredDataRows.length);
            exportButton.disabled = filteredDataRows.length === 0;
            
            if (filterDate && filteredDataRows.length === 0) {
                 showCustomAlert(`üîç Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu n√†o kh·ªõp v·ªõi ng√†y **${filterDate}** trong c·ªôt "${TARGET_DATE_COLUMN_NAME.toUpperCase()}".`);
            } else if (filterDate) {
                 const alertMsg = (originalAllDataRows.length - filteredDataRows.length) > 0 
                    ? `‚ö†Ô∏è ƒê√£ l·ªçc xong! T√¨m th·∫•y **${filteredDataRows.length}** h√†ng kh·ªõp v·ªõi ng√†y **${filterDate}**.`
                    : `‚úÖ ƒê√£ l·ªçc xong! T√¨m th·∫•y **${filteredDataRows.length}** h√†ng kh·ªõp v·ªõi ng√†y **${filterDate}**.`;

                 showCustomAlert(alertMsg);
            } else {
                 showCustomAlert(`‚úÖ ƒê√£ b·ªè l·ªçc. ƒêang hi·ªÉn th·ªã t·ªïng **${originalAllDataRows.length}** h√†ng.`);
            }
        }
        
        function updateFilterDisplay(filteredCount) {
             const filterDate = dateFilterElement.value;
             const totalRows = originalAllDataRows.length;
             const columnName = TARGET_DATE_COLUMN_NAME.toUpperCase();
             let filterStatus = "";

             let baseContentHTML = resultInfoElement.innerHTML;
             
             // T√¨m v√† gi·ªØ l·∫°i chi ti·∫øt file
             let fileDetailContent = baseContentHTML.substring(baseContentHTML.indexOf('Chi ti·∫øt File ƒë√£ G·ªôp:'));

             if (filterDate) {
                 filterStatus = `<p>
                     * ƒê√£ √°p d·ª•ng L·ªåC theo Ng√†y <strong class="highlight">${filterDate}</strong> tr√™n c·ªôt '${columnName}': <strong class="highlight">${filteredCount}</strong> h√†ng.
                 </p>`;
             } else if (dateColumnIndex !== -1) {
                 filterStatus = `<p style="color: #7F8C8D; font-weight: 600;">
                     * Ch∆∞a √°p d·ª•ng L·ªåC (C·ªôt '${columnName}' ƒë√£ ƒë∆∞·ª£c x√°c ƒë·ªãnh). ƒêang hi·ªÉn th·ªã to√†n b·ªô **${totalRows}** h√†ng.
                 </p>`;
             } else {
                 filterStatus = `<p class="error-message">
                     * **L∆ØU √ù:** Kh√¥ng t√¨m th·∫•y c·ªôt '${columnName}'. Kh√¥ng th·ªÉ l·ªçc theo ng√†y.
                 </p>`;
             }
             
             let htmlContent = `
                 <h2>K·∫øt qu·∫£ T·ªïng h·ª£p:</h2>
                 <p style="font-size: 1.1em; color: #3498DB; font-weight: 700;">
                     ‚úÖ ƒê√£ x·ª≠ l√Ω th√†nh c√¥ng File.<br>
                     T·ªïng s·ªë h√†ng d·ªØ li·ªáu G·ªêC G·ªòP L·∫†I: <strong class="highlight">${totalRows}</strong>
                 </p>
                 <hr style="border: 0; border-top: 1px dashed #BDC3C7; margin: 15px 0;">
                 ${filterStatus}
                 <hr style="border: 0; border-top: 1px dashed #BDC3C7; margin: 15px 0;">
             `;

             // Th√™m l·∫°i chi ti·∫øt file
             if (baseContentHTML.includes('Chi ti·∫øt File ƒë√£ G·ªôp:')) {
                 htmlContent += fileDetailContent;
             }

             resultInfoElement.innerHTML = htmlContent;
        }


        function updateResultDisplay(successFiles, failureMessages, totalRows) {
            let htmlContent = '';
            const columnName = TARGET_DATE_COLUMN_NAME.toUpperCase();
            
            if (successFiles.length > 0) {
                
                let filterStatus = `<p style="color: #7F8C8D; font-weight: 600;">
                    * ${dateColumnIndex !== -1 ? `Ch∆∞a √°p d·ª•ng L·ªåC (C·ªôt <strong class="highlight">${columnName}</strong> ƒë√£ s·∫µn s√†ng).` : `Kh√¥ng t√¨m th·∫•y c·ªôt <strong class="highlight">${columnName}</strong>. Kh√¥ng th·ªÉ l·ªçc.`} ƒêang hi·ªÉn th·ªã to√†n b·ªô **${totalRows}** h√†ng.
                </p>`;

                htmlContent += `
                    <h2>K·∫øt qu·∫£ T·ªïng h·ª£p:</h2>
                    <p style="font-size: 1.1em; color: #3498DB; font-weight: 700;">
                        ‚úÖ ƒê√£ x·ª≠ l√Ω th√†nh c√¥ng **${successFiles.length}/${successFiles.length + failureMessages.length}** file.<br>
                        T·ªïng s·ªë h√†ng d·ªØ li·ªáu G·ªêC G·ªòP L·∫†I: <strong class="highlight">${totalRows}</strong>
                    </p>
                    <hr style="border: 0; border-top: 1px dashed #BDC3C7; margin: 15px 0;">
                    ${filterStatus}
                    <hr style="border: 0; border-top: 1px dashed #BDC3C7; margin: 15px 0;">
                    <span style="font-weight: 700; color: #34495E;">Chi ti·∫øt File ƒë√£ G·ªôp:</span>
                    <ul style="margin-top: 10px;">
                `;
                
                successFiles.forEach(file => {
                    htmlContent += `<li>${file.name} (**${file.count}** h√†ng)</li>`;
                });
                htmlContent += '</ul>';

                if (failureMessages.length > 0) {
                    htmlContent += `<div class="error-message">
                        ‚ö†Ô∏è L·ªói (${failureMessages.length} file) - Kh√¥ng th·ªÉ tr√≠ch xu·∫•t d·ªØ li·ªáu:
                        <ul style="color: #E74C3C; list-style: none; padding-left: 0; margin-top: 5px; font-weight: normal;">
                            ${failureMessages.map(m => `- **${m.name}**: ${m.reason}`).join('')}
                        </ul>
                    </div>`;
                }
                
            } else {
                htmlContent = `<span class="error-message" style="border-left: none;">‚ùå Kh√¥ng th·ªÉ t·∫£i ho·∫∑c x·ª≠ l√Ω b·∫•t k·ª≥ file n√†o. Vui l√≤ng ki·ªÉm tra file v√† th·ª≠ l·∫°i.</span>`;
                if (failureMessages.length > 0) {
                    htmlContent += `<div class="error-message">
                        Chi ti·∫øt l·ªói:
                        <ul style="color: #E74C3C; list-style: none; padding-left: 0; margin-top: 5px; font-weight: normal;">
                            ${failureMessages.map(m => `- **${m.name}**: ${m.reason}`).join('')}
                        </ul>
                    </div>`;
                }
            }
            
            resultInfoElement.innerHTML = htmlContent;
        }

        function exportResult() {
            if (!isProcessed || filteredDataRows.length === 0) {
                showCustomAlert("‚ö†Ô∏è Vui l√≤ng g·ªôp file tr∆∞·ªõc ho·∫∑c danh s√°ch d·ªØ li·ªáu ƒëang tr·ªëng/ch∆∞a ƒë∆∞·ª£c l·ªçc.");
                return;
            }
            
            var sheetData = [finalHeaders, ...filteredDataRows]; 

            var workbook = XLSX.utils.book_new();
            var worksheet = XLSX.utils.aoa_to_sheet(sheetData);

            if (dateColumnIndex !== -1) {
                const dateNumFmt = 'dd/mm/yyyy hh:mm'; 
                
                for (let R = 1; R < sheetData.length; ++R) {
                    const cell_address = XLSX.utils.encode_cell({c: dateColumnIndex, r: R});
                    const cell = worksheet[cell_address];

                    if (cell && cell.t === 'd') {
                        cell.z = dateNumFmt; 
                    } 
                }
            }

            XLSX.utils.book_append_sheet(workbook, worksheet, "DuLieuTongHop_Loc");

            var currentDate = new Date();
            var dd = String(currentDate.getDate()).padStart(2, '0');
            var mm = String(currentDate.getMonth() + 1).padStart(2, '0');
            var hh = String(currentDate.getHours()).padStart(2, '0');
            var min = String(currentDate.getMinutes()).padStart(2, '0');
            
            var fileName = `GopFile_Filtered_${dd}${mm}_${hh}${min}_${filteredDataRows.length}Rows.xlsx`;

            XLSX.writeFile(workbook, fileName);
            
            showCustomAlert(`‚úÖ ƒê√£ xu·∫•t th√†nh c√¥ng file **${fileName}**! File ch·ª©a **${filteredDataRows.length}** h√†ng d·ªØ li·ªáu. (ƒê√£ t·ªëi ∆∞u ƒë·ªãnh d·∫°ng ng√†y th√°ng)`);
        }

        window.onload = function() {
            document.getElementById("storageFiles").focus();
        };

    </script>
</body>
</html>
